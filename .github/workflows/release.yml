name: Release

on:
  push:
    tags:
    - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  get-versions:
    name: Get Versions
    runs-on: ubuntu-latest
    outputs:
      service_ver: ${{ steps.tags.outputs.cli_ver }}
      core_ver: ${{ steps.tags.outputs.core_ver }}
    steps:
    - name: Check out Repository
      uses: actions/checkout@v6
      with:
        submodules: 'true'
        fetch-depth: 0

    - name: Extract Versions
      id: tags
      run: |
        # 1. Extract version variables
        SERVICE_VER=${GITHUB_REF#refs/tags/}

        cd openbq/core/
        CORE_VER=$(git describe --tags --abbrev=0)
        CORE_VER=${CORE_VER}

        # 2. Set GitHub Actions Outputs (for use in other steps
        echo "service_ver=$SERVICE_VER" >> $GITHUB_OUTPUT
        echo "core_ver=$CORE_VER" >> $GITHUB_OUTPUT

        # 3. Print to logs (using the local variables defined above)
        echo "------------------------------------------"
        echo "Triggering Tag: $GITHUB_REF"
        echo "OpenBQ Core Service Version: $SERVICE_VER"
        echo "OpenBQ Core Engine Version: $CORE_VER"
        echo "------------------------------------------"

        # 4. Generate Step Summary
        echo "### ðŸ“¦ Version Manifest" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Version |" >> $GITHUB_STEP_SUMMARY
        echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
        echo "| **OpenBQ Core Service** | \`$SERVICE_VER\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **OpenBQ Core Engine** | \`$CORE_VER\` |" >> $GITHUB_STEP_SUMMARY

  build:
    name: Build Architecture
    needs: get-versions
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
        - platform: linux/amd64
          runner: ubuntu-24.04
        - platform: linux/arm64
          runner: ubuntu-24.04-arm
    permissions:
      contents: read
      packages: write
    steps:
    - name: Check out Repository
      uses: actions/checkout@v6
      with:
        submodules: 'true'

    - name: Set lowercase image name
      run: |
        echo "IMAGE_NAME_LC=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Inspect Runner Hardware
      run: |
        echo "### Hardware Specs for ${{ matrix.platform }}"
        echo "Architecture: $(uname -m)"
        echo "CPU Cores: $(nproc)"
        echo "Memory: $(free -h | grep Mem | awk '{print $2}')"
        echo "Kernel: $(uname -r)"

    - name: Build and push by digest
      id: build
      uses: docker/build-push-action@v6
      with:
        context: .
        platforms: ${{ matrix.platform }}
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LC }}
        outputs: type=image,push-by-digest=true,name-canonical=true,push=true
        cache-from: type=gha,scope=build-${{ matrix.platform }}
        cache-to: type=gha,mode=max,scope=build-${{ matrix.platform }}
        labels: |
          bq.service.version=${{ needs.get-versions.outputs.service_ver }}
          bq.core.version=${{ needs.get-versions.outputs.core_ver }}

    - name: Export digest
      run: |
        mkdir -p /tmp/digests
        digest="${{ steps.build.outputs.digest }}"
        touch "/tmp/digests/${digest#sha256:}"          

    - name: Upload digest
      uses: actions/upload-artifact@v4
      with:
        name: digests-${{ strategy.job-index }}
        path: /tmp/digests/*
        if-no-files-found: error
        retention-days: 1

  merge:
    name: Merge and Tag
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      packages: write
    steps:
    - name: Download digests
      uses: actions/download-artifact@v4
      with:
        path: /tmp/digests
        pattern: digests-*
        merge-multiple: true

    - name: Set lowercase image name
      run: |
        echo "IMAGE_NAME_LC=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LC }}

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Create manifest list and push
      working-directory: /tmp/digests
      run: |
        docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
          --annotation "index:bq.core.version=${{ needs.get-versions.outputs.core_ver }}" \
          --annotation "index:bq.service.version=${{ needs.get-versions.outputs.service_ver }}" \
          $(printf '${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LC }}@sha256:%s ' *)
